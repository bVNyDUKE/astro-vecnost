---
import Layout from "layouts/Layout.astro";
import MapPage from "components/GoogleMap";
import { Okruzi } from "components/Map/MapData";
import { sp } from "supabase";

const getFillColor = (count: number): string => {
  switch (true) {
    case count > 0 && count <= 100:
      return "#f6eee0";
    case count > 100 && count <= 1000:
      return "#e4b7a0";
    case count > 1000 && count <= 3000:
      return "#c38370";
    case count > 5000:
      return "#A45C40";
    default:
      return "#f9f1f0";
  }
};

const { data: graveData } = await sp
  .from("groblje")
  .select("id, name, position")
  .not("position", "is", null);

const { data: perOkrugData } = await sp.rpc("persons_per_okrug");

const stats = Okruzi.map((okrug) => {
  const count = perOkrugData?.find((x) => okrug.id === x.okrug_id)?.count;
  return {
    id: okrug.id,
    name: okrug.name,
    mapId: okrug.mapId,
    count: count ?? 0,
    fillColor: getFillColor(count ?? 0),
  };
});
---

<Layout>
  <MapPage client:only="react" data={graveData} stats={stats} />
</Layout>
<style is:inline>
  nav {
    margin-bottom: 0px !important;
  }
</style>
